package launchers;

import java.awt.Container;
import java.awt.Dimension;
import java.awt.GridBagConstraints;
import java.awt.GridBagLayout;
import java.awt.Insets;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.io.BufferedReader;
import java.io.File;
import java.io.IOException;
import java.io.InputStreamReader;
import java.util.HashMap;
import java.util.List;

import javax.swing.JButton;
import javax.swing.JFileChooser;
import javax.swing.JFrame;
import javax.swing.JTextField;
import javax.swing.SwingUtilities;
import javax.swing.UIManager;
import javax.swing.UnsupportedLookAndFeelException;

import twitter4j.Query;
import twitter4j.QueryResult;
import twitter4j.Status;
import twitter4j.Twitter;
import twitter4j.TwitterException;
import twitter4j.TwitterFactory;
import twitter4j.auth.AccessToken;
import twitter4j.auth.RequestToken;
import twitter4j.conf.Configuration;
import twitter4j.conf.ConfigurationBuilder;
import utilities.InFile;
import utilities.OutFile;

public class TwitterScraper
{
	public static void main(String[] args)
	{
		SwingUtilities.invokeLater(new Runnable()
		{
			public void run()
			{
			    try
			    {
					createAndShowGUI();
				}
			    catch (ClassNotFoundException | InstantiationException | IllegalAccessException
						| UnsupportedLookAndFeelException e)
			    {
					e.printStackTrace();
				}
			}
		});
	}
	
	private static void createAndShowGUI() throws ClassNotFoundException, InstantiationException, 
	IllegalAccessException, UnsupportedLookAndFeelException
	{
		JFrame frame = new JFrame("GridBagLayoutDemo");
		frame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
		UIManager.setLookAndFeel(UIManager.getSystemLookAndFeelClassName());
		addComponentsToPane(frame.getContentPane());
		frame.pack();
		frame.setVisible(true);
	}
	
	public static void addComponentsToPane(Container pane)
	{
        JButton downloadButton, fileButton, closeButton;
        JTextField filePath = new JTextField("");
        filePath.setEnabled(false);
        
        final JFileChooser fc = new JFileChooser();
        fc.setCurrentDirectory(new File("C:\\Users\\Robbie\\Documents"));
        
        downloadButton = new JButton("Run Search");
        downloadButton.addActionListener(new ActionListener()
		{
        	public void actionPerformed(ActionEvent e)
        	{
        		downloadButton.setText("Running...");
        		downloadButton.setEnabled(false);
        		
        		new TwitterScraper().run(new File(filePath.getText()));
        		
        		downloadButton.setText("Run Search");
        		downloadButton.setEnabled(true);
        	}
		});
        
        fileButton = new JButton("Output File");
        fileButton.addActionListener(new ActionListener()
		{
        	public void actionPerformed(ActionEvent e)
        	{ 
        		int returnVal = fc.showOpenDialog(pane);
        		if (returnVal == JFileChooser.APPROVE_OPTION)
                    filePath.setText(fc.getSelectedFile().getAbsolutePath());
        	}
		});
        
        closeButton = new JButton("Close");
        closeButton.addActionListener(new ActionListener()
		{
        	public void actionPerformed(ActionEvent e)
        	{ 
        		System.exit(0);
        	}
		});
        
		pane.setLayout(new GridBagLayout());
		GridBagConstraints c = new GridBagConstraints();
		
		filePath.setPreferredSize(new Dimension(200, 10));
		filePath.setSize(filePath.getPreferredSize());
		
	    c.insets = new Insets(2,4,2,4);
	    c.fill = GridBagConstraints.BOTH;
	    c.gridx = 0;
	    c.gridy = 0;
	    pane.add(fileButton, c);

	    c.gridx = 1;
	    c.gridwidth = 2;
	    pane.add(filePath, c);
	    
	    c.gridwidth = 1;
	    c.gridx = 0;
	    c.gridy = 1;
	    pane.add(downloadButton, c);

		c.gridx = 2;
		c.gridy = 2;
		c.anchor = GridBagConstraints.EAST;
		pane.add(closeButton, c);
	}
	
	public void run(File outputFile)
	{
		HashMap<String, String> credentials = this.getCredentials();
		ConfigurationBuilder builder = new ConfigurationBuilder();
		
		builder.setOAuthConsumerKey(credentials.get("consumer_key"));
		builder.setOAuthConsumerSecret(credentials.get("consumer_secret"));
		builder.setOAuthAccessToken(credentials.get("access_key"));
		builder.setOAuthAccessTokenSecret(credentials.get("access_secret"));
		
		Configuration configuration = builder.build();
		TwitterFactory factory = new TwitterFactory(configuration);
		Twitter twitter = factory.getInstance();
		
		Query q = new Query("PCMH");
		QueryResult result = null;
		
		try
		{
			result = twitter.search(q);
		}
		catch (TwitterException e)
		{
			if (e.getStatusCode() == 401)
			{
				System.err.println("Access tokens invalid; create new access tokens.");
				twitter = this.newTokens(credentials);
				try
				{
					result = twitter.search(q);
				}
				catch (TwitterException e1)
				{
					System.err.println("Unhandled error in retreiving query results.");
					e1.printStackTrace();
				}
			}
			else
			{
				System.err.println("Unhandled error in retreiving query results.");
				e.printStackTrace();
			}
		}
		
		List<Status> tweets = result.getTweets();
		for (int i = 0; i < 10; i++)
			System.out.println("@" + tweets.get(i).getUser().getScreenName() + " - " + tweets.get(i).getText());
	}
	
	private HashMap<String, String> getCredentials()
	{
		HashMap<String, String> creds = new HashMap<String, String>();
		try
		{
			InFile in = new InFile(System.getProperty("user.dir") + "\\resources\\twitterOAuthCredentials.txt");
			String[] line = null;
			
			while (in.isReady())
			{
				line = in.readRowLite("\t");
				creds.put(line[0], line[1]);
			}
			
			in.close();
		}
		catch (IOException e)
		{
			System.err.println("Error getting OAuth credentials from file.");
			e.printStackTrace();
		}
		
		return creds;
	}
	
	private Twitter newTokens(HashMap<String, String> creds)
	{
		ConfigurationBuilder newBuild = new ConfigurationBuilder();
		
		newBuild.setOAuthConsumerKey(creds.get("consumer_key"));
		newBuild.setOAuthConsumerSecret(creds.get("consumer_secret"));
		newBuild.setOAuthAccessToken(null);
		newBuild.setOAuthAccessTokenSecret(null);
		
		Configuration config = newBuild.build();
		TwitterFactory factory = new TwitterFactory(config);
		Twitter tw = factory.getInstance();
		AccessToken accessToken = null;
		
		try
		{
			RequestToken request = tw.getOAuthRequestToken();
			
			BufferedReader br = new BufferedReader(new InputStreamReader(System.in));
			System.out.println("Copy/ paste the URL below into a web browser, authorize new access keys, "
					+ "and enter the PIN below.\r\nAuthorization URL:\r\n" + request.getAuthorizationURL());
			
			while (null == accessToken)
			{
				System.out.print("Enter access pin: ");
				String pin = br.readLine();
				accessToken = tw.getOAuthAccessToken(request, pin);
			}
		}
		catch (TwitterException e1)
		{
			System.err.println("Error getting access tokens");
			e1.printStackTrace();
		}
		catch (IOException e)
		{
			System.err.println("Invalid input.");
			e.printStackTrace();
		}
		
		creds.replace("access_key", accessToken.getToken());
		creds.replace("access_secret", accessToken.getTokenSecret());
		
		try
		{
			OutFile out = new OutFile(System.getProperty("user.dir")
					+ "\\resources\\twitterOAuthCredentials.txt", false);
			for (String key : creds.keySet())
				out.writeLine(key + "\t" + creds.get(key));
			out.close();
		}
		catch (IOException e1)
		{
			System.err.println("Error storing access tokens in file.");
			e1.printStackTrace();
		}
		
		return tw;
	}
}
